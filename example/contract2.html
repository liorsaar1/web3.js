<!doctype>
<html>

<head>
<script type="text/javascript" src="../dist/web3.js"></script>
<script type="text/javascript">

    var Web3 = require('web3');
    var web3 = new Web3();
    var providerUrl = 'http://lior.ide.tmp.ether.camp:8555/sandbox/a246b9ef3ac93a24d2486c8b2b3f91d960f52cdb'
    web3.setProvider(new web3.providers.HttpProvider(providerUrl));
    
    // solidity code code
    var source = "" +
    "contract test {\n" +
    "   function multiply(uint a) constant returns(uint d) {\n" +
    "       return a * 7;\n" +
    "   }\n" +
    "}\n";

    var compiled = web3.eth.compile.solidity(source);
    var code = compiled.test.code;
    // contract json abi, this is autogenerated using solc CLI
//    var abi = compiled.test.info.abiDefinition;
    var abi = compiled.test.info.abiDifinition;
    
    web3.eth.defaultAccount = "0x4ed0c969c46e1240173679183a31cf4d104c232c";
    var address = web3.eth.namereg().addr("Wallet");

    var client = new XMLHttpRequest();
    client.open('GET', 'contracts/Oracle.sol');
    client.onreadystatechange = function() {
        if (client.readyState === 4) {
            source = client.responseText;
            compiled = web3.eth.compile.solidity(source);
            code = compiled['Oracle'].code;
            abi = compiled['Oracle'].info.abiDifinition;
        }
    }
    client.send();

    var myContract;

    function createExampleContract() {
        document.getElementById('sandbox').innerText = providerUrl;

        // hide create button
        document.getElementById('create').style.visibility = 'hidden'; 
        document.getElementById('code').innerText = code;

        // let's assume that coinbase is our account
//        web3.eth.defaultAccount = web3.eth.coinbase; // "0x4ed0c969c46e1240173679183a31cf4d104c232c"
        web3.eth.defaultAccount = "0x4ed0c969c46e1240173679183a31cf4d104c232c";

        // create contract
        document.getElementById('status').innerText = "transaction sent, waiting for confirmation";
        web3.eth.contract(abi).new({data: code}, function (err, contract) {
            if(err) {
                console.error(err);
                return;

            // callback fires twice, we only want the second call when the contract is deployed
            } else if(contract.address){

                myContract = contract;
                console.log('address: ' + myContract.address);
                document.getElementById('status').innerText = 'Mined!';
                document.getElementById('call').style.visibility = 'visible';
            }
        });
    }

    function callExampleContract() {
        // this should be generated by ethereum
        var param = parseInt(document.getElementById('value').value);

        // call the contract
        var res = myContract.multiply(param);
        document.getElementById('result').innerText = res.toString(10);
    }
    
    function testGet() {

        // call the contract
        var result = myContract.readValue();
        document.getElementById('getResult').innerText = result.toString(10);
    }
    
    function writeValueClicked() {
        var param = parseInt(document.getElementById('writeValue').value);

        // call the contract
        var res = myContract.writeValue(param);
        document.getElementById('result').innerText = res;
    }
    


</script>
</head>
<body>
    <h1>contract h</h1>
    <div id="sandbox"></div> 
    <div id="code"></div> 
    <div id="status"></div>
    <div id='create'>
        <button type="button" onClick="createExampleContract();">create example contract</button>
    </div>
    <div id='call' style='visibility: hidden;'>
        <input type="number" id="value" onkeyup='callExampleContract()'></input>
    </div>
    <div id="result"></div>
    
    <div id='testGet'>
        <button type="button" onClick="testGet();">get()</button>
    </div>
    <div id="getResult">???</div>
    
    <div>
        <button type="button" onClick="writeValueClicked();">write</button>
    </div>
    <div>
        <input type="number" id="writeValue"></input>
    </div>

</body>
</html>

