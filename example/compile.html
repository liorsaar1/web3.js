<!doctype>
<html>

<head>
<script type="text/javascript" src="../dist/web3.js"></script>
<script type="text/javascript">

    var Web3 = require('web3');
    var web3 = new Web3();
    var providerUrl = 'http://lior.ide.tmp.ether.camp:8555/sandbox/fcf505162288127c15aa6e80181bb6afa13156af'
    web3.setProvider(new web3.providers.HttpProvider(providerUrl));
    
    
    function loadUrl(url, callback) {
        var client = new XMLHttpRequest();
        client.open('GET', url);
        client.onreadystatechange = function() {
            if (client.readyState === 4) {
                var content = client.responseText;
                callback(content);
            }
        }
        client.send();
    }
    
    function compileUrl(name, url, callback) {
        function loaded(content) {
           console.log(content);
           var conDef = compileSource(name, content);
           setContract(conDef.abi, conDef.code, callback);
        }
        loadUrl(url, loaded);
    }
    
    function compileSource(name, source) {
        var compiled = web3.eth.compile.solidity(source);
        var code = compiled[name].code;
        // contract json abi, this is autogenerated using solc CLI
        // var abi = compiled.test.info.abiDefinition;
        var abi = compiled[name].info.abiDifinition; // 911 - ALEX !!
        return {code:code, abi:abi};
    }
    
    function setContract(abi, code, callback) {
        web3.eth.defaultAccount = "0x4ed0c969c46e1240173679183a31cf4d104c232c";
        web3.eth.contract(abi).new({data: code}, function (err, contract) {
            if(err) {
                console.error(err);
                callback(err);
                return;
            }

            // callback fires twice, we only want the second call when the contract is deployed
            if(contract.address){
                console.log('address: ' + contract.address);
                callback(null, contract);
            }
        });
    }
    
    var oracleContract;
    var readInterval;
    function onload() {
        console.log("loaded");
        document.getElementById('sandbox').innerText = providerUrl;
        document.getElementById('status').innerText = "transaction sent, waiting for confirmation";
        
        document.getElementById('ui').style.visibility = 'hidden';
        compileUrl('Oracle', 'contracts/Oracle.sol', function(err, contract) {
            if (err) {
                console.log(err);
                return;
            }
            // contract loaded and compiled
            oracleContract = contract;
            document.getElementById('ui').style.visibility = 'visible';
            document.getElementById('status').innerText = 'Mined!';
            // read loop

            readInterval = setInterval(readIntervalHandler, 2000);            
        });
    }
    
    function readIntervalHandler() {
        readValueClicked();
    }
    
    function readValue() {
        var result = oracleContract.readValue();
        return result.toString(10);
    }
    
    function readValueClicked() {
        document.getElementById('readResult').innerText = readValue();
    }
    
    function writeValueClicked() {
        var value = parseInt(document.getElementById('writeValue').value);
        var res = writeValue(value);
    }
    
    function writeValue(value) {
        return  oracleContract.writeValue(value);
    }


</script>
</head>
<body onload="onload()">
    <h1>Oracle</h1>
    Sandbox:
    <div id="sandbox">---</div></br>
    Status:
    <div id="status">---</div></br>
    
    <div id="ui">
    
        <div>
            <button type="button" onClick="readValueClicked();">read</button>
        </div>
        <div id="readResult">???</div>
        
        <div>
            <button type="button" onClick="writeValueClicked();">write</button>
        </div>
        <div>
            <input type="number" id="writeValue"></input>
        </div>
    </div>

</body>
</html>

